---
- name: swapoff
  shell: swapoff -a

# tasks file for master
- name: Reset Kubernetes Master
  shell: kubeadm reset -f
  register: kubeadm_reset

- name: Render kubeadm-config.yaml
  template:
    src: kubeadm-config.yaml.j2
    dest: /root/kubeadm-config.yaml

- name: "Initialize Master {{ kubernetes_version }}"
  shell: kubeadm init --ignore-preflight-errors=all --config=/root/kubeadm-config.yaml
  when: kubeadm_reset is succeeded and inventory_hostname == groups['masters'][0]
  register: join_cmd

- debug:
    var=join_cmd
# - name: Create Kubernetes config directory
#   file:
#     path: /root/.kube/
#     state: directory
#     owner: root
#     group: root
#     mode: 0755

# - name: Copy admin.conf to config directory
#   copy:
#     src: /etc/kubernetes/admin.conf
#     dest: /root/.kube/config
#     owner: root
#     group: root
#     mode: 0755
#     remote_src: yes
#     backup: yes
#   when: kubeadm_init

# - name: Join Kubernetes Cluster
#   shell: kubeadm join --ignore-preflight-errors=all --token {{ token }} {{ groups['master'][0] }}:6443 --discovery-token-unsafe-skip-ca-verification
#   when: kubeadm_reset is succeeded
#   register: kubeadm_join

# - name: Install Flannel (Networking)
#   shell: "kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/{{ flannel_version }}/Documentation/kube-flannel.yml" 

# - name: Poke kubelet
#   systemd:
#     name: kubelet
#     state: restarted
#     daemon_reload: yes
#     enabled: yes
#   register: kubelet_poke
